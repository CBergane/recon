#cloud-config
package_update: true
package_upgrade: false

packages:
  - git
  - make
  - tmux
  - jq
  - ripgrep
  - moreutils
  - chromium
  - fonts-liberation
  - pandoc
  - golang-go
  - bind9-dnsutils
  - massdns
  - seclists
  - pv
  - parallel
  - libpcap-dev
  - pkg-config

write_files:
  # Exportera GOPATH i shell-sessioner (för go install)
  - path: /etc/profile.d/go.sh
    permissions: '0644'
    content: |
      export GOPATH=/root/go
      export PATH="$GOPATH/bin:/usr/local/go/bin:$PATH"

  # tmux: ett fönster, tre rutor (vänster stor för körning, höger topp logg, höger botten watch)
  - path: /root/tmux_recon.sh
    permissions: '0755'
    content: |
      #!/bin/bash
      set -Eeuo pipefail
      SESSION="recon"
      BASE="/root/recon/live"
      mkdir -p "$BASE"
      cd "$BASE"

      if ! tmux has-session -t "$SESSION" 2>/dev/null; then
        # Pane 0 (vänster 70%) – interaktiv körning
        tmux new-session -d -s "$SESSION" -n main "cd $BASE; clear; echo '[run] make run PROFILE=\${PROFILE:-vps}'; bash"
        # Pane 1 (höger 30%)
        tmux split-window -t "$SESSION:0" -h -p 30 "cd $BASE; bash"
        # Pane 2 (höger-nere 50% av höger)
        tmux split-window -t "$SESSION:0.1" -v -p 50 "cd $BASE; bash"

        tmux select-pane -t "$SESSION:0.0"; tmux select-pane -T "RUN"
        tmux select-pane -t "$SESSION:0.1"; tmux select-pane -T "LOGS"
        tmux select-pane -t "$SESSION:0.2"; tmux select-pane -T "WATCH"

        # LOGS: håll out.latest uppdaterad och följ run.log
        tmux send-keys -t "$SESSION:0.1" \
          'mkdir -p out; while true; do D=$(ls -1td out/* 2>/dev/null | head -1); if [ -n "$D" ]; then ln -sfn "$D" out.latest; echo "[logs] Tailing $D/run.log"; tail -F "$D/run.log"; fi; sleep 2; done' C-m
        # WATCH: enkel dashboard
        tmux send-keys -t "$SESSION:0.2" \
          'mkdir -p out; while true; do D=$(ls -1td out/* 2>/dev/null | head -1); clear; date; if [ -n "$D" ]; then ln -sfn "$D" out.latest; echo; ls -lh "$D" | sed -n "1,40p"; echo; echo "[nuclei]"; tail -n 40 "$D/nuclei_findings.txt" 2>/dev/null || true; fi; sleep 5; done' C-m
      fi

      # Autorun om markeringsfil finns
      if [ -f /root/recon/.autorun ]; then
        tmux send-keys -t "$SESSION:0.0" 'make run PROFILE=vps' C-m
      fi

      tmux attach -t "$SESSION"

runcmd:
  # 1) Klona ditt repo
  - [ bash, -lc, "mkdir -p /root/recon && cd /root/recon && if [ ! -d live ]; then git clone --depth 1 https://github.com/CBergane/recon.git live; else cd live && git pull --ff-only || true; fi" ]

  # 2) Länka resolvers till input/ och gör skript körbara
  - [ bash, -lc, "cd /root/recon/live && mkdir -p input && ln -sfn $(pwd)/resolvers.txt input/resolvers.txt && ln -sfn $(pwd)/resolvers6.txt input/resolvers6.txt && ln -sfn $(pwd)/resolvers-trusted.txt input/resolvers-trusted.txt" ]
  - [ bash, -lc, "cd /root/recon/live && chmod +x recon.sh || true" ]
  - [ bash, -lc, "cd /root/recon/live && chmod +x resolver-healthcheck.sh || true" ]

  # (valfritt) kör din healthcheck för resolvers (om den finns i repot)
  - [ bash, -lc, "cd /root/recon/live && ./resolver-healthcheck.sh || true" ]

  # 3) Installera beroenden & förbered
  - [ bash, -lc, "source /etc/profile.d/go.sh && cd /root/recon/live && make install" ]
  - [ bash, -lc, "cd /root/recon/live && make prepare" ]

  # 4) Starta tmux-layouten
  - [ bash, -lc, "/root/tmux_recon.sh" ]

final_message: "cloud-init complete — repo klonat, make install/prepare kört, tmux-session 'recon' startad"
